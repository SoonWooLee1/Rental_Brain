<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devoops.rentalbrain.common.segmentrebuild.command.mapper.SegmentTransitionCommandMapper">

    <!-- 고객의 계약 건수 -->
    <select id="countContracts" resultType="int">
        SELECT COUNT(*)
        FROM contract
        WHERE cum_id = #{customerId}
    </select>

    <!-- 고객의 현재 세그먼트 -->
    <select id="findCurrentSegmentId" resultType="long">
        SELECT segment_id
        FROM customer
        WHERE id = #{customerId}
    </select>

    <!-- 잠재(1) → 신규(2) 승격 -->
    <update id="promotePotentialToNew">
        UPDATE customer
        SET segment_id = 2
        WHERE id = #{customerId}
        AND segment_id = 1
    </update>

    <!-- 세그먼트 변경 이력 저장 -->
    <insert id="insertSegmentHistory" parameterType="map">
        INSERT INTO customer_segment_history (
        customer_id,
        previous_segment_id,
        current_segment_id,
        reason,
        trigger_type,
        reference_type,
        reference_id,
        changed_at,
        created_at
        )
        VALUES (
        #{customerId},
        #{previousSegmentId},
        #{currentSegmentId},
        #{reason},
        #{triggerType},
        #{referenceType},
        #{referenceId},
        NOW(),
        NOW()
        )
    </insert>

</mapper>