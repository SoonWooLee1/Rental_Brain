<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devoops.rentalbrain.customer.customeranalysis.customersupportanalysis.query.mapper.QuoteInsightQueryMapper">

    <resultMap id="QuoteInsightRowMap"
               type="com.devoops.rentalbrain.customer.customeranalysis.customersupportanalysis.query.dto.QuoteInsightRowDTO">
        <id property="quoteId" column="quote_id"/>
        <result property="counselingDate" column="counseling_date"/>

        <result property="quoteSummary" column="quote_summary"/>
        <result property="quoteContent" column="quote_content"/>

        <result property="customerId" column="customer_id"/>
        <result property="customerName" column="customer_name"/>
        <result property="channelName" column="channel_name"/>

        <result property="isSuccess" column="is_success"/>
    </resultMap>

    <select id="selectQuoteInsightRows" resultMap="QuoteInsightRowMap">
        SELECT
            q.id              AS quote_id,
            q.counseling_date AS counseling_date,
            q.summary         AS quote_summary,
            q.content         AS quote_content,
            q.cum_id          AS customer_id,
            c.name            AS customer_name,
            ch.name           AS channel_name,
            CASE
                WHEN EXISTS (
                    SELECT 1
                    FROM contract ct
                    WHERE ct.cum_id = q.cum_id
                      AND ct.start_date &gt;= q.counseling_date
                      AND ct.start_date &lt; DATE_ADD(q.counseling_date, INTERVAL #{windowDays} DAY)
                ) THEN 1
                ELSE 0
                END AS is_success
        FROM quote q
                 LEFT JOIN customer c ON c.id = q.cum_id
                 LEFT JOIN channel ch ON ch.id = q.channel_id
        WHERE q.counseling_date &gt;= #{start}
          AND q.counseling_date &lt;  #{end}
        ORDER BY q.counseling_date DESC
    </select>
</mapper>
